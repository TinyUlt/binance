<!DOCTYPE html>
<html>
<body>
<script type="text/javascript" src="js/loader.js"></script>
<script  type="text/javascript" src="js/jquery.min.js"></script>


<script type="text/javascript">

    let pricelist = null;
    let symbol = null;
    let email = null;
    function printPriceList() {

        let priceTable = document.getElementById('priceTable');
        while(priceTable.hasChildNodes()){
            priceTable.removeChild(priceTable.lastChild)
        }

        for(let i = 0; i < pricelist.length; i++){
            let tr = document.createElement("tr");
            priceTable.appendChild(tr);
            let tdPrice = document.createElement("td");
            let tdDisc = document.createElement("td");
            let tdDelete = document.createElement("td");
            priceTable.appendChild(tdPrice);
            priceTable.appendChild(tdDisc);
            priceTable.appendChild(tdDelete);


            let labelPrice=document.createElement("label");
            labelPrice.textContent = pricelist[i].price;

            let labelDisc=document.createElement("label");
            labelDisc.textContent = pricelist[i].disc;

            let button=document.createElement("button");
            button.textContent='delete';
            button.onclick = function () {
                let price = pricelist[i];

                var tina = pricelist.filter((p) => {
                    return p == price;
                });
                var index = pricelist.indexOf(tina[0]);
                index > -1 && pricelist.splice(index, 1);

                console.log(pricelist);
                pushPriceList();
            };

            tdPrice.appendChild(labelPrice);
            tdDisc.appendChild(labelDisc);
            tdDelete.appendChild(button);
            document.body.appendChild(priceTable);
        }
    }
    function createSymbol(s){
        _get = `/d_createSymbol?email=${email}&symbol=${s}`;
        console.log(_get);
        $.post(_get,function(cd,status){

            getEnableSymbols();

        });
    }
    function deleteSymbol(s){
        _get = `/d_deleteSymbol?email=${email}&symbol=${s}`;
        console.log(_get);
        $.post(_get,function(cd,status){

            getEnableSymbols();

        });
    }
    function getPriceList() {
        if(symbol!==null && symbol!==""){
            _get = `/d_getPriceList?email=${email}&symbol=${symbol}`;
            console.log(_get);
            $.post(_get,function(cd,status){

                pricelist = JSON.parse(cd);

                console.log(pricelist);

                printPriceList();

            });
        }


    }
    function pushPriceList() {
        _get = `/d_pushPriceList?email=${email}&symbol=${symbol}&priceList=${JSON.stringify(pricelist)}`;
        console.log(_get);
        $.post(_get,function(cd,status){

            pricelist = JSON.parse(cd);

            console.log(pricelist);

            printPriceList();

        });

    }
    function getPrice(){
        if(symbol!==null && symbol!==""){
            _get = `/d_getPrice?email=${email}&symbol=${symbol}`;

            $.post(_get,function(cd,status){

                console.log(cd);
                let nowPrice = JSON.parse(cd);
                document.getElementById('nowPrice').textContent=`Now Price:${nowPrice}`;

            });
        }

    }

    function getEnableSymbols(){
        _get = `/d_getEnableSymbols?email=${email}`;

        $.post(_get,function(cd,status){

            console.log(cd);
            document.getElementById('divAll').style.visibility="visible";

            let divEmail = document.getElementById('divEmail');
            while(divEmail.hasChildNodes()){
                divEmail.removeChild(divEmail.lastChild)
            }
            let labelEmail=document.createElement("label");
            labelEmail.textContent = email;
            divEmail.appendChild(labelEmail);


            let symbols = JSON.parse(cd);

            let symbolSelect = document.getElementById('symbol');
            while(symbolSelect.hasChildNodes()){
                symbolSelect.removeChild(symbolSelect.lastChild)
            }

           for(let i=0;i<symbols.length;i++){
               let option = document.createElement("option");
               option.value = symbols[i];
               option.textContent = symbols[i];
               symbolSelect.appendChild(option);
           }
            changeSymbol();
            self.setInterval("clock()",2000);
        });
    }
    function clock()
    {

        getPrice();
        getPriceList();
    }
    function changeSymbol(){
        symbol = document.getElementById("symbol").value;
        console.log(symbol);
        getPrice();
        getPriceList();
        document.getElementById('input').value="";
        document.getElementById('disc').value="";
    }

    $(document).ready(function(){

        document.getElementById('create').onclick = function () {
            pricelist.push({'price':parseFloat(document.getElementById('input').value), 'disc':document.getElementById('disc').value});
            pushPriceList();

        };
        document.getElementById('createSymbol').onclick = function () {

            createSymbol(document.getElementById("createSymbolInput").value);

        };
        document.getElementById('deleteSymbol').onclick = function () {

            deleteSymbol(document.getElementById("createSymbolInput").value);

        };

        document.getElementById('Login').onclick = function () {

            email = document.getElementById("emailInput").value;
            getEnableSymbols();


        };





    });

</script>
<div id="divEmail">
    <label >Email:</label>
    <input type="input" id="emailInput"/>
    <button id="Login">Login or Create</button>
</div>
<div id="divAll" style="visibility:hidden;">

    <div >
        <label >create Symbol:</label>
        <input type="input" id="createSymbolInput"/>
        <button id="createSymbol">Create</button>
        <button id="deleteSymbol">Delete</button>
    </div>

    <div>
        <select id="symbol" onchange="changeSymbol()">
            <!--<option value="ETHUSDT">ETHUSDT</option>-->
            <!--<option value="ZRXUSDT">ZRXUSDT</option>-->
        </select>
    </div>


    <div>
        <label id="nowPrice">Now Price:</label>
    </div>


    <label >price:</label>
    <input type="input" id="input"/>
    <label >disc:</label>
    <input type="input" id="disc"/>
    <button id="create">Create</button>

    <table id="priceTable" border="0">

    </table>
</div>


</body>
</html>